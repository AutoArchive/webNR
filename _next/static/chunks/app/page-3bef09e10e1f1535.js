(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{258:(e,t,r)=>{Promise.resolve().then(r.bind(r,4450))},477:()=>{},4450:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>ef});var a=r(5155),s=r(2115),o=r(6489);let n=e=>{let{buttons:t=[],onBackClick:r,title:s}=e,{t:n}=(0,o.B)();return(0,a.jsxs)("header",{className:"flex h-14 px-4 border-b border-gray-200 dark:border-gray-700",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[r&&(0,a.jsx)("button",{onClick:r,className:" p-2 rounded-lg transition-colors flex-shrink-0 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 ","aria-label":n("common.back"),children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})})}),(0,a.jsx)("h1",{className:"text-lg sm:text-xl font-bold text-gray-900 dark:text-gray-100 truncate min-w-0",children:s})]}),(0,a.jsx)("div",{className:"flex items-center gap-2 ml-4 flex-shrink-0",children:t.map((e,t)=>(0,a.jsx)("button",{onClick:e.onClick,className:" p-2 rounded-lg transition-colors text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 ","aria-label":e.ariaLabel,children:e.icon},t))})]})};var l=r(9362),i=r(3189),d=r(4134).hp;function c(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}class g{static async getDB(){return new Promise((e,t)=>{let r=indexedDB.open(this.DB_NAME,this.DB_VERSION);r.onerror=()=>t(r.error),r.onsuccess=()=>e(r.result),r.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(this.NOVELS_STORE)||t.createObjectStore(this.NOVELS_STORE,{keyPath:"id"}),t.objectStoreNames.contains(this.CONTENT_STORE)||t.createObjectStore(this.CONTENT_STORE,{keyPath:"id"}),t.objectStoreNames.contains(this.REPOS_STORE)||t.createObjectStore(this.REPOS_STORE,{keyPath:"url"})}})}static async saveNovel(e,t){let r=await this.getDB();return new Promise((a,s)=>{let o=r.transaction([this.NOVELS_STORE,this.CONTENT_STORE],"readwrite");o.objectStore(this.NOVELS_STORE).put(e),o.objectStore(this.CONTENT_STORE).put({id:e.id,content:t}),o.oncomplete=()=>a(),o.onerror=()=>s(o.error)})}static async getAllNovels(){let e=await this.getDB();return new Promise((t,r)=>{let a=e.transaction(this.NOVELS_STORE,"readonly").objectStore(this.NOVELS_STORE).getAll();a.onsuccess=()=>t(a.result),a.onerror=()=>r(a.error)})}static async getNovelContent(e){let t=await this.getDB();return new Promise((r,a)=>{let s=t.transaction(this.CONTENT_STORE,"readonly").objectStore(this.CONTENT_STORE).get(e);s.onsuccess=()=>{var e;return r((null===(e=s.result)||void 0===e?void 0:e.content)||"")},s.onerror=()=>a(s.error)})}static async updateNovelProgress(e,t){let r=await this.getDB();return new Promise((a,s)=>{let o=r.transaction(this.NOVELS_STORE,"readwrite"),n=o.objectStore(this.NOVELS_STORE),l=n.get(e);l.onsuccess=()=>{let e=l.result;e&&(e.lastPosition=t,e.lastRead=Date.now(),n.put(e))},o.oncomplete=()=>a(),o.onerror=()=>s(o.error)})}static async deleteNovel(e){let t=await this.getDB();return new Promise((r,a)=>{let s=t.transaction([this.NOVELS_STORE,this.CONTENT_STORE],"readwrite");s.objectStore(this.NOVELS_STORE).delete(e),s.objectStore(this.CONTENT_STORE).delete(e),s.oncomplete=()=>r(),s.onerror=()=>a(s.error)})}static async detectAndDecodeText(e){try{return new i.TextDecoder("utf-8",{fatal:!0}).decode(e)}catch(s){let t=new Uint8Array(e),r=l.detect(d.from(t));if(!r.encoding)throw Error("Could not detect file encoding");let a={ascii:"windows-1252","iso-8859-1":"windows-1252","windows-1252":"windows-1252",gb2312:"gb18030",gbk:"gb18030",big5:"big5","euc-jp":"euc-jp","shift-jis":"shift-jis","euc-kr":"euc-kr"}[r.encoding.toLowerCase()]||r.encoding;try{return new i.TextDecoder(a).decode(e)}catch(t){return console.error("Failed to decode with detected encoding:",a,t),new i.TextDecoder("utf-8").decode(e)}}}static async importFromFile(e){return new Promise((t,r)=>{let a=new FileReader;a.onload=async a=>{try{var s;let r=null===(s=a.target)||void 0===s?void 0:s.result;if(!r)throw Error("Failed to read file content");let o=await this.detectAndDecodeText(r),n={id:c(),title:e.name.replace(/\.[^/.]+$/,""),source:"local",filepath:e.name,lastRead:Date.now(),lastPosition:0,bookmarks:[],chapters:[]};await this.saveNovel(n,o),t(n)}catch(e){r(e)}},a.onerror=()=>r(Error("Failed to read file")),a.readAsArrayBuffer(e)})}static async importFromUrl(e,t){let r=await fetch(e,{signal:t});if(!r.ok)throw Error("Failed to fetch novel content");let a=await r.text(),s=decodeURIComponent(e.split("/").pop()||"Unknown"),o={id:c(),title:s.replace(/\.[^/.]+$/,""),source:"url",url:e,lastRead:Date.now(),lastPosition:0,bookmarks:[],chapters:[]};return await this.saveNovel(o,a),o}static async findNovelByUrl(e){return(await this.getAllNovels()).find(t=>t.url===e)}static async saveRepository(e){let t=await this.getDB();return new Promise((r,a)=>{let s=t.transaction(this.REPOS_STORE,"readwrite");s.objectStore(this.REPOS_STORE).put(e),s.oncomplete=()=>r(),s.onerror=()=>a(s.error)})}static async getAllRepositories(){let e=await this.getDB();return new Promise((t,r)=>{let a=e.transaction(this.REPOS_STORE,"readonly").objectStore(this.REPOS_STORE).getAll();a.onsuccess=()=>t(a.result),a.onerror=()=>r(a.error)})}static async deleteRepository(e){let t=await this.getDB();return new Promise((r,a)=>{let s=t.transaction(this.REPOS_STORE,"readwrite");s.objectStore(this.REPOS_STORE).delete(e),s.oncomplete=()=>r(),s.onerror=()=>a(s.error)})}static async exportNovelAsTxt(e){let t=await this.getDB(),r=await new Promise((r,a)=>{let s=t.transaction(this.NOVELS_STORE,"readonly").objectStore(this.NOVELS_STORE).get(e);s.onsuccess=()=>{s.result?r(s.result):a(Error("Novel not found"))},s.onerror=()=>a(s.error)}),a=new Blob([await this.getNovelContent(e)],{type:"text/plain;charset=utf-8"}),s=URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download="".concat(r.title,".txt"),document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}}g.DB_NAME="NovelDB",g.DB_VERSION=1,g.REPOS_STORE="repositories",g.NOVELS_STORE="novels",g.CONTENT_STORE="content";let h=e=>{let{filterQuery:t,onFilterChange:r,sortBy:s,onSortChange:n,isSelectionMode:l,selectedCount:i,onSelectionModeToggle:d,onDeleteSelected:c,onExportSelected:g}=e,{t:h}=(0,o.B)();return(0,a.jsxs)("div",{className:"mb-6 flex items-center justify-between gap-4",children:[(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)("input",{type:"text",placeholder:h("library.search"),value:t,onChange:e=>r(e.target.value),className:"w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent"})}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("select",{value:s,onChange:e=>n(e.target.value),className:"px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400",children:[(0,a.jsx)("option",{value:"lastRead",children:h("library.sort.recentlyRead")}),(0,a.jsx)("option",{value:"title",children:h("library.sort.title")})]}),(0,a.jsx)("button",{onClick:d,className:"px-4 py-2 rounded-lg transition-colors ".concat(l?"bg-blue-500 hover:bg-blue-600 text-white":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700"),children:h(l?"library.cancel":"library.select")}),l&&i>0&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("button",{onClick:g,className:"px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white transition-colors",children:[h("library.export")," (",i,")"]}),(0,a.jsxs)("button",{onClick:c,className:"px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white transition-colors",children:[h("library.delete")," (",i,")"]})]})]})]})},u=e=>{let{novel:t,isSelectionMode:r,isSelected:o,onSelect:n,onClick:l}=e,[i,d]=(0,s.useState)(!1);return(0,a.jsx)("div",{onClick:()=>l(t),onMouseDown:()=>d(!0),onMouseUp:()=>d(!1),onMouseLeave:()=>d(!1),className:"\n                cursor-pointer rounded-lg overflow-hidden\n                transition-all duration-100 ease-in-out\n                bg-white dark:bg-gray-800 shadow-sm\n                hover:scale-[1.02] hover:shadow-md\n                ".concat(i?"scale-[0.98] bg-gray-50 dark:bg-gray-700":"","\n                active:scale-[0.98] active:bg-gray-50 dark:active:bg-gray-700\n            "),children:(0,a.jsxs)("div",{className:"flex items-center gap-4 p-4 w-full",children:[r&&(0,a.jsx)("div",{className:"flex-shrink-0",children:(0,a.jsx)("input",{type:"checkbox",checked:o,onChange:()=>n(t.id),onClick:e=>e.stopPropagation(),className:"w-5 h-5 rounded border-gray-300 dark:border-gray-600"})}),(0,a.jsx)("div",{className:"w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded flex items-center justify-center text-2xl flex-shrink-0",children:"\uD83D\uDCD6"}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("h3",{className:"font-bold text-gray-900 dark:text-gray-100 truncate",children:t.title}),t.author&&(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400 truncate",children:t.author})]}),(0,a.jsx)("div",{className:"text-xs text-gray-400 dark:text-gray-500 whitespace-nowrap",children:new Date(t.lastRead).toLocaleDateString()})]})})},x=e=>{let{onNovelSelect:t}=e,{t:r}=(0,o.B)(),[n,l]=(0,s.useState)([]),[i,d]=(0,s.useState)("lastRead"),[c,x]=(0,s.useState)(""),[m,p]=(0,s.useState)(new Set),[y,v]=(0,s.useState)(!1);(0,s.useEffect)(()=>{(async()=>{try{let e=await g.getAllNovels();l(e)}catch(e){console.error("Failed to load novels:",e)}})()},[]);let b=n.filter(e=>{var t;return e.title.toLowerCase().includes(c.toLowerCase())||(null===(t=e.author)||void 0===t?void 0:t.toLowerCase().includes(c.toLowerCase()))}).sort((e,t)=>{switch(i){case"title":return e.title.localeCompare(t.title);case"lastRead":return t.lastRead-e.lastRead;default:return 0}}),f=e=>{let t=new Set(m);t.has(e)?t.delete(e):t.add(e),p(t)},k=e=>{y?f(e.id):t(e)},w=async()=>{if(confirm("Are you sure you want to delete the selected novels?")){for(let e of m)await g.deleteNovel(e);l(n.filter(e=>!m.has(e.id))),p(new Set),v(!1)}},j=async()=>{try{for(let e of m)await g.exportNovelAsTxt(e);p(new Set),v(!1)}catch(e){console.error("Failed to export novels:",e),alert("Failed to export novels. Please try again.")}};return(0,a.jsxs)("div",{className:"p-4 h-full overflow-auto",children:[(0,a.jsx)(h,{filterQuery:c,onFilterChange:x,sortBy:i,onSortChange:d,isSelectionMode:y,selectedCount:m.size,onSelectionModeToggle:()=>{v(!y),y||p(new Set)},onDeleteSelected:w,onExportSelected:j}),(0,a.jsx)("div",{className:"space-y-2",children:b.map(e=>(0,a.jsx)(u,{novel:e,isSelectionMode:y,isSelected:m.has(e.id),onSelect:f,onClick:k},e.id))}),0===n.length&&(0,a.jsx)("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:r("library.noNovels")})]})},m=e=>{let{content:t,currentOffset:r,onPositionChange:o,fontSize:n,charsPerPage:l=500}=e,i=(0,s.useRef)(null),[d,c]=(0,s.useState)(1),[g,h]=(0,s.useState)(1),[u,x]=(0,s.useState)([]),[m,p]=(0,s.useState)(null),[y,v]=(0,s.useState)(null);(0,s.useEffect)(()=>{if(!t){x([]);return}let e=[],r="",a=0;for(let s of t.split(/\n+/))if(r&&a+s.length>l&&(e.push(r.trim()),r="",a=0),s.length>l)for(let t of s.split(/(\s+)/))a+t.length>l?(e.push(r.trim()),r=t,a=t.length):(r+=t,a+=t.length);else r+=s+"\n",a+=s.length+1;r&&e.push(r.trim()),x(e),h(e.length)},[t,l]),(0,s.useEffect)(()=>{t&&c(Math.min(Math.floor(r/l)+1,g))},[r,l,g,t]);let b=(0,s.useCallback)(e=>{if(!t||0===u.length)return;let r="next"===e?Math.min(d+1,g):Math.max(d-1,1);r!==d&&(o((r-1)*l),i.current&&(i.current.scrollTop=0))},[t,d,g,l,o,u.length]);(0,s.useEffect)(()=>{let e=e=>{if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement))switch(e.key){case"ArrowRight":case"ArrowDown":case" ":e.preventDefault(),b("next");break;case"ArrowLeft":case"ArrowUp":e.preventDefault(),b("prev");break;case"Home":e.preventDefault(),o(0);break;case"End":e.preventDefault(),o((g-1)*l)}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[b,o,g,l]);let f=(0,s.useCallback)(e=>{let t=i.current&&i.current.scrollHeight-i.current.scrollTop<=i.current.clientHeight+1,r=i.current&&0===i.current.scrollTop;(e.deltaY>0&&t||e.deltaY<0&&r)&&(e.preventDefault(),b(e.deltaY>0?"next":"prev"))},[b]);return(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsx)("div",{ref:i,className:" flex-1 rounded-t-md overflow-y-auto min-h-0 bg-white dark:bg-gray-900  text-gray-900 dark:text-gray-100 shadow-sm dark:shadow-gray-950/50 scrollbar-thin scrollbar-thumb-gray-300 hover:scrollbar-thumb-gray-400  dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500  scrollbar-track-transparent ",onWheel:f,onTouchStart:e=>{v(null),p({x:e.targetTouches[0].clientX,y:e.targetTouches[0].clientY})},onTouchMove:e=>{v({x:e.targetTouches[0].clientX,y:e.targetTouches[0].clientY})},onTouchEnd:()=>{if(!m||!y)return;let e=m.x-y.x;Math.abs(e)>Math.abs(m.y-y.y)&&Math.abs(e)>50&&(e>0?b("next"):b("prev")),p(null),v(null)},children:(0,a.jsx)("div",{className:"p-4 sm:p-6",children:(0,a.jsx)("pre",{className:"whitespace-pre-wrap font-sans leading-relaxed m-0 text-justify hyphens-auto break-words",style:{fontSize:"".concat(n,"px"),lineHeight:"1.5"},children:u[d-1]||""})})}),(0,a.jsxs)("div",{className:" min-h-[2.5rem] px-2 sm:px-4 py-2 bg-white dark:bg-gray-900  text-gray-900 dark:text-gray-100 border-t border-gray-200 dark:border-gray-800 shadow-sm dark:shadow-gray-950/50 rounded-b-md flex items-stretch gap-2 ",children:[(0,a.jsx)("button",{onClick:()=>b("prev"),disabled:d<=1,className:" flex-1 rounded-md transition-all duration-200 flex items-center justify-center text-gray-700 dark:text-gray-300  hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-800 dark:hover:text-gray-100 disabled:bg-transparent disabled:text-gray-300 dark:disabled:text-gray-700 disabled:hover:bg-transparent disabled:cursor-not-allowed ","aria-label":"Previous page",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,a.jsxs)("div",{className:"flex items-center gap-2 sm:gap-3 justify-center min-w-[150px] px-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[(0,a.jsx)("span",{className:"text-xs font-medium text-gray-600 dark:text-gray-400",children:"Page"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-900 dark:text-gray-200",children:d}),(0,a.jsx)("span",{className:"text-xs text-gray-400 dark:text-gray-600",children:"/"}),(0,a.jsx)("span",{className:"text-xs text-gray-400 dark:text-gray-600",children:g})]}),(0,a.jsx)("div",{className:"hidden sm:block h-4 w-px bg-gray-200 dark:bg-gray-700"}),(0,a.jsxs)("span",{className:"text-xs font-medium text-gray-600 dark:text-gray-400 tabular-nums",children:[t?(d/g*100).toFixed(2):"0.00","%"]})]}),(0,a.jsx)("button",{onClick:()=>b("next"),disabled:d>=g,className:" flex-1 rounded-md transition-all duration-200 flex items-center justify-center text-gray-700 dark:text-gray-300  hover:bg-gray-100 hover:text-gray-900 dark:hover:bg-gray-800 dark:hover:text-gray-100 disabled:bg-transparent disabled:text-gray-300 dark:disabled:text-gray-700 disabled:hover:bg-transparent disabled:cursor-not-allowed ","aria-label":"Next page",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]})]})};var p=r(5964),y=r.n(p),v=r(1959),b=r.n(v);let f=e=>{let{progress:t}=e;return(0,a.jsxs)("div",{className:" min-h-[2.5rem] px-2 sm:px-4 py-2 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-sm dark:shadow-gray-900/20 rounded-b-md flex flex-wrap items-center justify-between gap-2 ",children:[(0,a.jsx)("div",{className:"flex items-center gap-2 sm:gap-3 order-1",children:(0,a.jsxs)("div",{className:"flex items-center gap-1 sm:gap-1.5",children:[(0,a.jsx)("span",{className:"text-xs font-medium text-gray-600 dark:text-gray-400",children:"Progress"}),(0,a.jsxs)("span",{className:"text-sm font-medium text-gray-900 dark:text-gray-200 tabular-nums",children:[t,"%"]})]})}),(0,a.jsx)("div",{className:"flex-1 min-w-[100px] max-w-[12rem] h-1.5 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden order-3 sm:order-2",children:(0,a.jsx)("div",{className:"h-full rounded-full transition-all duration-200 bg-gray-400 dark:bg-gray-500",style:{width:"".concat(t,"%")}})})]})};var k=r(2109);let w="reader_chunks_cache",j=e=>(0,k.SHA256)(e).toString(),N=e=>{try{let t=localStorage.getItem(w);if(!t)return null;let r=JSON.parse(t);if(r.hash!==e||Date.now()-r.timestamp>864e5)return null;return r.chunks}catch(e){return console.warn("Error reading chunks cache:",e),null}},S=(e,t)=>{try{let r={hash:e,chunks:t,timestamp:Date.now()};localStorage.setItem(w,JSON.stringify(r))}catch(e){console.warn("Error saving chunks cache:",e)}},C=e=>{let{content:t,currentOffset:r,onPositionChange:o,fontSize:n}=e,l=(0,s.useRef)(null),i=(0,s.useMemo)(()=>(null==t?void 0:t.length)||0,[t]),d=(0,s.useRef)(!1),c=(0,s.useRef)(0),g=(0,s.useRef)(r),h=(0,s.useMemo)(()=>{if(!t)return[];let e=j(t),r=N(e);if(r)return r;let a=[],s=0;for(;s<t.length;){let e=s+1e3;if(e<t.length){for(;e<t.length&&"\n"!==t[e]&&"."!==t[e];)e++;e++}else e=t.length;a.push({id:"chunk-".concat(s),startOffset:s,endOffset:e,content:t.slice(s,e)}),s=e}return S(e,a),a},[t]),u=(0,s.useMemo)(()=>{let e=h.find(e=>r>=e.startOffset&&r<=e.endOffset);return null==e?void 0:e.id},[h,r]);(0,s.useEffect)(()=>{if(!l.current||!u)return;let e=document.getElementById(u);e&&!d.current&&Date.now()-c.current>=2e3&&e.scrollIntoView({behavior:"smooth",block:"start"})},[u,2e3]);let x=(0,s.useMemo)(()=>b()(()=>{if(!l.current||!h.length)return;let e=l.current,t=e.scrollTop,a=t+e.clientHeight,s=null,n=0;if(h.forEach(e=>{let r=document.getElementById(e.id);if(!r)return;let o=r.getBoundingClientRect(),l=r.offsetTop,i=Math.max(0,Math.min(a,l+o.height)-Math.max(t,l));i>n&&(n=i,s=e)}),s){let e=s.startOffset;Math.abs(e-r)>100&&(c.current=Date.now(),g.current=e,o(e))}},250,{leading:!0,trailing:!0}),[h,r,o]),m=(0,s.useCallback)(()=>{l.current&&(d.current=!0,x())},[x]),p=(0,s.useMemo)(()=>y()(function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!i||!t&&d.current)return;let a=Date.now()-c.current;if(!t&&a<2e3)return;let{scrollHeight:s,clientHeight:o}=e,n=Math.round(r/i*(s-o));(t||Math.abs(e.scrollTop-n)>2*o)&&e.scrollTo({top:n,behavior:t?"auto":"smooth"})},250),[r,i,2e3]),v=(0,s.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];l.current&&p(l.current,e)},[p]),k=(0,s.useCallback)(()=>{d.current=!0},[]),w=(0,s.useMemo)(()=>y()(()=>{d.current=!1},1e3),[]),C=(0,s.useCallback)(()=>{w()},[w]);return(0,s.useEffect)(()=>{let e=l.current;return e&&(e.addEventListener("touchstart",k),e.addEventListener("mousedown",k),e.addEventListener("touchend",C),e.addEventListener("mouseup",C)),()=>{e&&(e.removeEventListener("touchstart",k),e.removeEventListener("mousedown",k),e.removeEventListener("touchend",C),e.removeEventListener("mouseup",C)),x.cancel(),p.cancel(),w.cancel()}},[k,C,x,p,w]),(0,s.useEffect)(()=>{r!==g.current?(g.current=r,v(!0)):Date.now()-c.current>=2e3&&v(!1)},[r,v,2e3]),(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsx)("div",{ref:l,className:" flex-1 rounded-t-md overflow-y-auto min-h-0 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 shadow-sm dark:shadow-gray-900/20 scrollbar-thin scrollbar-thumb-gray-300 hover:scrollbar-thumb-gray-400 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500 scrollbar-track-transparent ",onScroll:m,children:(0,a.jsx)("div",{className:"p-4 sm:p-6",children:h.map(e=>(0,a.jsx)("p",{id:e.id,className:"whitespace-pre-wrap font-sans leading-relaxed m-0 text-justify hyphens-auto break-words",style:{fontSize:"".concat(n,"px"),lineHeight:"1.5"},children:e.content},e.id))})}),(0,a.jsx)(f,{progress:(r/i*100).toFixed(2)})]})},L=/^(?:chapter|第.*[章节]|[第序]|卷|章|section|part|book|\d+|NO.*|CHAPTER)/i,R=(e,t)=>{let r;let a=e.split("\n");try{r=t?RegExp(t,"i"):L}catch(e){console.error("Invalid regex pattern:",e),r=L}let s=[],o="",n="",l=0,i=0;return a.forEach(e=>{r.test(e.trim())?(n&&s.push({title:n,content:o,startIndex:l}),n=e.trim(),l=i,o=""):o+=e+"\n",i+=e.length+1}),n&&s.push({title:n,content:o,startIndex:l}),s.length>0?s:[{title:"Full Text",content:e,startIndex:0}]},E=(e,t)=>{let r=localStorage.getItem(e);if(!r)return t;try{return JSON.parse(r)}catch(e){return t}},M=(e,t)=>{localStorage.setItem(e,JSON.stringify(t))},T=e=>{let{currentPosition:t,onPositionChange:r,onBack:o}=e,[n,l]=(0,s.useState)([]);(0,s.useEffect)(()=>{l(E("bookmarks",[]))},[]),(0,s.useEffect)(()=>{M("bookmarks",n)},[n]);let i=e=>{l(t=>t.filter((t,r)=>r!==e))};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("button",{onClick:o,className:"flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white",children:[(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),(0,a.jsx)("span",{children:"Back"})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:"Bookmarks"}),(0,a.jsx)("button",{onClick:()=>{let e={offset:t,timestamp:Date.now()};l(t=>[...t,e])},className:"px-3 py-1.5 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm",children:"Add Bookmark"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[n.map((e,t)=>(0,a.jsxs)("div",{className:"relative group flex items-center gap-2 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700",children:[(0,a.jsxs)("button",{onClick:()=>r(e.offset),className:"flex-1 text-left",children:[(0,a.jsxs)("div",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:["Position ",Math.round(e.offset)]}),(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:new Date(e.timestamp).toLocaleString()})]}),(0,a.jsx)("button",{onClick:()=>i(t),className:"p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity",children:(0,a.jsx)("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},t)),0===n.length&&(0,a.jsx)("p",{className:"text-center py-4 text-sm text-gray-500 dark:text-gray-400",children:"No bookmarks yet"})]})]})},P=e=>{let{content:t,currentPosition:r,onPositionChange:o,onBack:n,chapters:l}=e,[i,d]=(0,s.useState)(()=>E("chapterPattern","")),[c,g]=(0,s.useState)(!1),[h,u]=(0,s.useState)(i),[x,m]=(0,s.useState)(l||[]),p=(0,s.useRef)(null);(0,s.useEffect)(()=>{m(R(t,i))},[t,i]);let y=x.findIndex((e,t)=>{let a=x[t+1];return e.startIndex<=r&&(!a||a.startIndex>r)});(0,s.useEffect)(()=>{if(y>=0&&p.current){let e=p.current,t=e.children[y];if(t){let r=e.clientHeight,a=t.offsetTop-r/2+t.clientHeight/2;e.scrollTo({top:a,behavior:"smooth"})}}},[y]);let v=e=>{console.log("Jumping to chapter at position:",e),o(e)};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("button",{onClick:n,className:"flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white",children:[(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),(0,a.jsx)("span",{children:"Back"})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:"Chapters"}),(0,a.jsx)("button",{onClick:()=>g(!c),className:"px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-sm text-gray-900 dark:text-gray-100",children:c?"Cancel":"Set Pattern"})]}),c&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Chapter Pattern (Regular Expression)"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"text",value:h,onChange:e=>u(e.target.value),placeholder:"Enter regex pattern...",className:"flex-1 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,a.jsx)("button",{onClick:()=>{d(h),M("chapterPattern",h),g(!1)},className:"px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white",children:"Save"})]}),(0,a.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Leave empty to use default pattern. Example: ^Chapter \\d+"})]}),(0,a.jsx)("div",{ref:p,className:"space-y-2 max-h-[60vh] overflow-y-auto pr-2",children:x.map((e,t)=>{let r=t===y;return(0,a.jsxs)("button",{onClick:()=>v(e.startIndex),className:"\n                                w-full p-3 rounded-lg text-left transition-colors relative\n                                ".concat(r?"bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 ring-2 ring-blue-500":"bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100","\n                            "),children:[(0,a.jsx)("span",{className:"block text-sm font-medium truncate",children:e.title}),r&&(0,a.jsx)("span",{className:"absolute right-2 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-blue-500"})]},t)})})]})},O=e=>{let{onNavigate:t}=e,{t:r}=(0,o.B)(),s=[{id:"settings",label:r("reader.menu.settings"),icon:"⚙️"},{id:"bookmarks",label:r("reader.menu.bookmarks"),icon:"\uD83D\uDD16"},{id:"chapters",label:r("reader.menu.chapters"),icon:"\uD83D\uDCD1"},{id:"search",label:r("reader.menu.search"),icon:"\uD83D\uDD0D"}];return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:r("reader.menu.title")}),s.map(e=>{let{id:r,label:s,icon:o}=e;return(0,a.jsxs)("button",{onClick:()=>t(r),className:"w-full flex items-center gap-4 p-4 rounded-lg bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:[(0,a.jsx)("span",{className:"text-2xl",children:o}),(0,a.jsx)("span",{className:"text-lg font-medium text-gray-900 dark:text-gray-100",children:s})]},r)})]})},B=e=>{let{progress:t,onProgressChange:r}=e,[o,n]=(0,s.useState)(!1),l=e=>{let t=e.currentTarget.getBoundingClientRect();r(Math.max(0,Math.min(1,(("touches"in e?e.touches[0].clientX:e.clientX)-t.left)/t.width)))},i=e=>{n(!0),l(e)},d=e=>{o&&l(e)},c=()=>{n(!1)},g=Math.round(100*t);return(0,a.jsx)("div",{className:"px-6 py-4 border-t border-gray-200 dark:border-gray-700",children:(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between text-xs text-gray-500 dark:text-gray-400",children:[(0,a.jsx)("span",{children:"Beginning"}),(0,a.jsxs)("span",{children:[g,"%"]}),(0,a.jsx)("span",{children:"End"})]}),(0,a.jsxs)("div",{className:"relative h-2 bg-gray-200 dark:bg-gray-700 rounded-full cursor-pointer touch-none",onMouseDown:i,onMouseMove:d,onMouseUp:c,onMouseLeave:c,onTouchStart:i,onTouchMove:d,onTouchEnd:c,children:[(0,a.jsx)("div",{className:"absolute h-full bg-blue-500 rounded-full transition-all duration-100",style:{width:"".concat(g,"%")}}),(0,a.jsx)("div",{className:"absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-blue-500 rounded-full shadow-md -ml-2  hover:scale-110 hover:bg-blue-600 active:scale-95 transition-all duration-200",style:{left:"".concat(g,"%")}})]})]})})},D=e=>{let{content:t,onPositionChange:r,onBack:o}=e,[n,l]=(0,s.useState)(""),[i,d]=(0,s.useState)([]),c=(0,s.useCallback)(()=>{if(!n.trim()||!t)return;let e=[],r=n.toLowerCase(),a=0;for(;a<t.length;){let s=t.toLowerCase().indexOf(r,a);if(-1===s)break;let o=Math.max(0,s-50),n=Math.min(t.length,s+r.length+50),l=t.slice(o,n);e.push({text:l,index:s}),a=s+1}d(e)},[n,t]),g=e=>{r(e)};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("button",{onClick:o,className:"flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white",children:[(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),(0,a.jsx)("span",{children:"Back"})]}),(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:"Search"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"text",value:n,onChange:e=>l(e.target.value),onKeyDown:e=>"Enter"===e.key&&c(),placeholder:"Enter search term...",className:"flex-1 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,a.jsx)("button",{onClick:c,className:"px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white",children:"Search"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[i.map((e,t)=>{let r=e.text.toLowerCase().indexOf(n.toLowerCase()),s=e.text.slice(0,r),o=e.text.slice(r,r+n.length),l=e.text.slice(r+n.length);return(0,a.jsx)("button",{onClick:()=>g(e.index),className:"w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-left",children:(0,a.jsxs)("p",{className:"text-sm text-gray-900 dark:text-gray-100",children:[s,(0,a.jsx)("span",{className:"bg-yellow-200 dark:bg-yellow-900 font-medium",children:o}),l]})},t)}),n&&0===i.length&&(0,a.jsx)("p",{className:"text-center py-4 text-sm text-gray-500 dark:text-gray-400",children:"No results found"})]})]})},I=e=>{let{fontSize:t,onFontSizeChange:r,isPaged:n,onModeToggle:l,onBack:i,charsPerPage:d=500,onCharsPerPageChange:c}=e,{t:g}=(0,o.B)(),[h,u]=(0,s.useState)("light");return(0,s.useEffect)(()=>{document.documentElement.classList.contains("dark")&&u("dark")},[]),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("button",{onClick:i,className:" flex items-center gap-2  text-gray-700 dark:text-gray-300  hover:text-gray-900 hover:bg-gray-100 dark:hover:text-white dark:hover:bg-gray-800 rounded-md p-1.5 -ml-1.5 transition-colors duration-200 ",children:[(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),(0,a.jsx)("span",{children:g("common.back")})]}),(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:g("common.settings")}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:g("settings.theme")}),(0,a.jsxs)("button",{onClick:()=>{let e="light"===h?"dark":"light";u(e),"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),localStorage.setItem("theme",e)},className:" w-full flex items-center justify-between p-3  bg-gray-100 dark:bg-gray-800  hover:bg-gray-200 dark:hover:bg-gray-700 text-left rounded-lg transition-colors duration-200 ",children:[(0,a.jsx)("span",{className:"text-gray-900 dark:text-gray-100",children:g("light"===h?"settings.themeLight":"settings.themeDark")}),(0,a.jsx)("div",{className:"relative",children:"light"===h?(0,a.jsx)("svg",{className:"w-5 h-5 text-gray-700 dark:text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"})}):(0,a.jsx)("svg",{className:"w-5 h-5 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"})})})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:g("settings.fontSize")}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)("button",{onClick:()=>r(t-1),className:" p-2 rounded-lg  bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors duration-200 ",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),(0,a.jsx)("span",{className:"text-gray-900 dark:text-gray-100 tabular-nums w-8 text-center",children:t}),(0,a.jsx)("button",{onClick:()=>r(t+1),className:" p-2 rounded-lg  bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors duration-200 ",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:g("settings.readingMode")}),(0,a.jsx)("button",{onClick:l,className:" w-full p-3 rounded-lg  bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-left transition-colors duration-200 ",children:(0,a.jsx)("span",{className:"text-gray-900 dark:text-gray-100",children:g(n?"settings.pagedMode":"settings.scrollMode")})})]}),n&&c&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:g("settings.charactersPerPage")}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)("button",{onClick:()=>c(Math.max(200,d-100)),className:" p-2 rounded-lg  bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors duration-200 ",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),(0,a.jsx)("span",{className:"text-gray-900 dark:text-gray-100 tabular-nums w-16 text-center",children:d}),(0,a.jsx)("button",{onClick:()=>c(Math.min(2e3,d+100)),className:" p-2 rounded-lg  bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors duration-200 ",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})]})]})]})},U=e=>{let{isOpen:t,onClose:r,config:o,onConfigChange:n,novel:l,content:i,currentPosition:d,onPositionChange:c}=e,[g,h]=(0,s.useState)("main");return t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-40",onClick:r}),(0,a.jsxs)("div",{className:" fixed right-0 top-0 h-full w-[min(100vw-3rem,24rem)] bg-white dark:bg-gray-900 shadow-xl z-50 flex flex-col ",children:[(0,a.jsx)("button",{onClick:r,className:"absolute top-4 right-4 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800",children:(0,a.jsx)("svg",{className:"w-5 h-5 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-6 overscroll-contain",children:["main"===g&&(0,a.jsx)(O,{onNavigate:h}),"settings"===g&&(0,a.jsx)(I,{fontSize:o.fontSize,onFontSizeChange:e=>n({fontSize:e}),isPaged:o.isPaged,onModeToggle:()=>n({isPaged:!o.isPaged}),onBack:()=>h("main"),charsPerPage:o.charsPerPage,onCharsPerPageChange:e=>n({charsPerPage:e})}),"bookmarks"===g&&(0,a.jsx)(T,{currentPosition:d,onPositionChange:c,onBack:()=>h("main")}),"chapters"===g&&(0,a.jsx)(P,{content:i,currentPosition:d,onPositionChange:c,onBack:()=>h("main"),chapters:null==l?void 0:l.chapters}),"search"===g&&(0,a.jsx)(D,{content:i,onPositionChange:c,onBack:()=>h("main")})]}),(0,a.jsx)(B,{progress:i?d/i.length:0,onProgressChange:e=>{c(Math.floor(e*i.length))}})]})]}):null},z=e=>{try{return new Intl.DisplayNames(["en"],{type:"language"}).of(e)||e}catch(t){return console.warn("Failed to get language display name:",t),({en:"English",es:"Spanish",fr:"French",de:"German",it:"Italian",pt:"Portuguese",ru:"Russian",zh:"Chinese",ja:"Japanese",ko:"Korean"})[e]||e}},F=e=>{let{rate:t,onRateChange:r,selectedVoice:n,onVoiceChange:l,voices:i}=e,{t:d}=(0,o.B)(),c=s.useMemo(()=>{let e=new Map;return i.forEach(t=>{try{var r;let a=t.lang.split("-")[0].toLowerCase(),s=z(a);e.has(s)||e.set(s,[]),null===(r=e.get(s))||void 0===r||r.push(t)}catch(e){console.warn("Error processing voice:",t,e)}}),new Map([...e.entries()].sort())},[i]),g=s.useMemo(()=>{if(!n)return"";try{let e=n.lang.split("-")[0].toLowerCase();return z(e)}catch(e){return console.warn("Error getting current language:",e),n.lang||""}},[n]),h=e=>{localStorage.setItem("tts-rate",e.toString()),r(e)},u=e=>{localStorage.setItem("tts-voice",e.name),l(e)};(0,s.useEffect)(()=>{if(i.length>0){let e=localStorage.getItem("tts-voice"),t=localStorage.getItem("tts-rate");if(e){let t=i.find(t=>t.name===e);t&&l(t)}t&&r(parseFloat(t))}},[i,l,r]);let[x,m]=(0,s.useState)(null);return((0,s.useEffect)(()=>{let e;let t=()=>{try{let a=window.speechSynthesis.getVoices();0===a.length?e=setTimeout(t,1e3):(l(a[0]),r(1),m(null))}catch(e){console.error("Error initializing voices:",e),m("Failed to initialize speech synthesis")}},a=()=>{clearTimeout(e),t()};return"speechSynthesis"in window?(window.speechSynthesis.addEventListener("voiceschanged",a),t()):m("Speech synthesis not supported in this browser"),()=>{clearTimeout(e),"speechSynthesis"in window&&window.speechSynthesis.removeEventListener("voiceschanged",a)}},[l,r]),x)?(0,a.jsx)("div",{className:"p-4 text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-lg",children:x}):(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:d("tts.speed")}),(0,a.jsx)("input",{type:"range",min:"0.5",max:"2",step:"0.1",value:t,onChange:e=>h(parseFloat(e.target.value)),className:"w-full accent-blue-500"}),(0,a.jsxs)("div",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:[t,"x"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:d("tts.language")}),(0,a.jsx)("select",{value:g,onChange:e=>{let t=e.target.value,r=c.get(t)||[];r.length>0&&l(r[0])},className:"w-full rounded-md border-gray-300 dark:border-gray-600  bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-blue-500 focus:border-blue-500",children:Array.from(c.keys()).map(e=>(0,a.jsx)("option",{value:e,children:e},e))})]}),g&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:d("tts.voice")}),(0,a.jsx)("div",{className:"space-y-2",children:(c.get(g)||[]).map(e=>(0,a.jsxs)("label",{className:"flex items-center space-x-2 p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[(0,a.jsx)("input",{type:"radio",name:"voice",checked:(null==n?void 0:n.name)===e.name,onChange:()=>u(e),className:"text-blue-500 focus:ring-blue-500"}),(0,a.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:e.name})]},e.name))})]})]})};class A{speak(e,t,r){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4?arguments[4]:void 0;if(!this.isInitialized){s.onError();return}try{this.stop();let o=new SpeechSynthesisUtterance(e);o.voice=t,o.rate=r,this.utterance=o,this.synthesis.speaking&&this.synthesis.cancel(),o.onboundary=e=>{void 0!==e.charIndex&&s.onBoundary(a+e.charIndex)},o.onend=()=>{this.utterance=null,s.onEnd()},o.onstart=()=>{s.onStart()},o.onerror=e=>{console.error("Speech synthesis error:",e),this.utterance=null,s.onError()},this.synthesis.speak(o)}catch(e){console.error("Error in speech synthesis:",e),s.onError()}}stop(){this.synthesis.cancel(),this.utterance=null}isPlaying(){return this.synthesis.speaking}constructor(){this.utterance=null,this.isInitialized=!1,"speechSynthesis"in window?(this.synthesis=window.speechSynthesis,this.isInitialized=!0):(console.warn("Speech synthesis not supported"),this.synthesis={})}}let _=e=>{let{content:t,currentOffset:r,onPositionChange:n,fontSize:l}=e,{t:i}=(0,o.B)(),[d,c]=(0,s.useState)(!1),[g,h]=(0,s.useState)(r),[u,x]=(0,s.useState)(1),[m,p]=(0,s.useState)(null),y=(0,s.useRef)(new A),[v,b]=(0,s.useState)(null),k=(0,s.useMemo)(()=>{let e=t.split(/\n+/),r=[];for(let t=0;t<e.length;t+=2){let a=e.slice(t,t+2).join("\n");a.trim()&&r.push(a)}return r},[t]),w=(0,s.useMemo)(()=>{let e=0;for(let t=0;t<k.length;t++){let r=k[t].length+1;if(g<(e+=r))return console.log("Found chunk index:",{index:t,totalLength:e,currentPosition:g,chunkLength:r}),t}return k.length-1},[k,g]),j=(0,s.useCallback)(e=>{let t=0;for(let r=0;r<e;r++)t+=k[r].length,t+=1;return console.log("Calculated offset:",{index:e,offset:t,chunkLengths:k.slice(0,e).map(e=>e.length)}),t},[k]),N=(0,s.useCallback)(e=>{if(!m||e>=k.length){b("No voice selected or invalid chunk");return}let t=k[e],r=j(e);y.current.speak(t,m,u,r,{onBoundary:e=>{h(e),n(e)},onEnd:()=>{e<k.length-1?N(e+1):c(!1)},onStart:()=>{b(null),c(!0)},onError:()=>{b("Speech synthesis failed. Please try again."),c(!1)}})},[k,m,u,n,j]),S=(0,s.useCallback)(()=>{d?(y.current.stop(),c(!1)):N(w)},[d,w,N]),C=(0,s.useCallback)(()=>{if(!d&&w<k.length-1){let e=w+1,t=j(e);console.log("Going to next chunk:",{nextIndex:e,newOffset:t,currentChunkIndex:w,currentPosition:g,chunkContent:k[e],chunkLength:k[e].length}),h(t),n(t)}},[d,w,k,j,n,g]),L=(0,s.useCallback)(()=>{if(!d&&w>0){let e=j(w-1);h(e),n(e),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},100)}},[d,w,j,n]);(0,s.useEffect)(()=>{let e=()=>{let e=window.speechSynthesis.getVoices();e.length&&!m&&p(e[0])};return window.speechSynthesis.addEventListener("voiceschanged",e),e(),()=>{window.speechSynthesis.removeEventListener("voiceschanged",e)}},[m]),(0,s.useEffect)(()=>()=>{window.speechSynthesis&&window.speechSynthesis.cancel()},[]),(0,s.useEffect)(()=>{h(r)},[r]);let R=k[w]||"",E=g/t.length*100,M=(w+1)/k.length*100;return(0,a.jsxs)("div",{className:"h-full flex flex-col bg-white dark:bg-gray-800",children:[v&&(0,a.jsx)("div",{className:"px-4 py-2 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400",children:v}),(0,a.jsxs)("div",{className:"px-4 py-2 border-b dark:border-gray-700",children:[(0,a.jsxs)("div",{className:"text-sm text-gray-600 dark:text-gray-400 flex justify-between items-center",children:[(0,a.jsx)("span",{children:" "+w+"1 / "+k.length}),(0,a.jsxs)("span",{children:[Math.round(E),"%"]})]}),(0,a.jsx)("div",{className:"mt-1 h-1 bg-gray-200 dark:bg-gray-700 rounded-full",children:(0,a.jsx)("div",{className:"h-full bg-blue-500 rounded-full transition-all duration-300",style:{width:"".concat(M,"%")}})})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-hidden flex",children:[(0,a.jsx)("div",{className:"w-1/2 p-6 border-r dark:border-gray-700",children:(0,a.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,a.jsx)("div",{className:"max-w-xl w-full",children:(0,a.jsx)("p",{className:"whitespace-pre-line text-center font-sans leading-relaxed  text-gray-900 dark:text-gray-100 bg-blue-50 dark:bg-gray-700/50  p-4 rounded-lg",style:{fontSize:"".concat(l,"px")},children:R})})})}),(0,a.jsx)("div",{className:"w-1/2 p-6 overflow-y-auto border-l dark:border-gray-700",children:(0,a.jsx)(F,{rate:u,onRateChange:x,selectedVoice:m,onVoiceChange:p,voices:window.speechSynthesis.getVoices()})})]}),(0,a.jsx)("div",{className:"p-4 border-t dark:border-gray-700",children:(0,a.jsxs)("div",{className:"max-w-xl mx-auto",children:[(0,a.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,a.jsx)("button",{onClick:L,disabled:d||0===w,className:"flex-1 py-2 px-4 rounded-lg bg-gray-200 hover:bg-gray-300  disabled:opacity-50 disabled:cursor-not-allowed text-gray-800 font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white dark:focus:ring-offset-gray-800",children:i("tts.previous")}),(0,a.jsx)("button",{onClick:C,disabled:d||w===k.length-1,className:"flex-1 py-2 px-4 rounded-lg bg-gray-200 hover:bg-gray-300  disabled:opacity-50 disabled:cursor-not-allowed text-gray-800 font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white dark:focus:ring-offset-gray-800",children:i("tts.next")})]}),(0,a.jsx)("button",{onClick:S,className:"w-full py-4 px-6 rounded-lg bg-blue-500 hover:bg-blue-600  text-white font-semibold text-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800",children:i(d?"tts.stop":"tts.start")}),(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsx)(f,{progress:E.toFixed(2)})})]})})]})},V={fontSize:20,isPaged:!1,charsPerPage:500},W=e=>{let{content:t,currentOffset:r,onPositionChange:o,defaultConfig:n={},showMenu:l=!1,onMenuClose:i=()=>{},isTTSMode:d=!1}=e,[c,g]=(0,s.useState)({...V,...n});return(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsx)("div",{className:"flex-1 min-h-0",children:d?(0,a.jsx)(_,{content:t,currentOffset:r,onPositionChange:o,fontSize:c.fontSize}):c.isPaged?(0,a.jsx)(m,{content:t,currentOffset:r,onPositionChange:o,fontSize:c.fontSize,charsPerPage:c.charsPerPage}):(0,a.jsx)(C,{content:t,currentOffset:r,onPositionChange:o,fontSize:c.fontSize})}),(0,a.jsx)(U,{isOpen:l,onClose:i,config:c,onConfigChange:e=>{g(t=>({...t,...e}))},content:t,currentPosition:r,onPositionChange:o})]})},H=()=>{let{language:e,setLanguage:t}=(0,o.B)();return(0,a.jsxs)("select",{value:e,onChange:e=>t(e.target.value),className:"bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2",children:[(0,a.jsx)("option",{value:"en",children:"English"}),(0,a.jsx)("option",{value:"zh",children:"中文"})]})},G={GITHUB_REPO:"https://github.com/yunwei37/webNR",HOME_PAGE:"https://www.webnovel.win"};function $(e){let{className:t="h-5 w-5"}=e;return(0,a.jsx)("svg",{className:t,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})}function J(e){let{className:t="h-5 w-5"}=e;return(0,a.jsx)("svg",{className:t,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})}function Y(e){let{className:t="h-5 w-5"}=e;return(0,a.jsx)("svg",{className:t,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})}function X(e){let{className:t="h-5 w-5"}=e;return(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:t,viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z",clipRule:"evenodd"})})}function K(e){let{className:t="h-5 w-5"}=e;return(0,a.jsx)("svg",{className:t,viewBox:"0 0 24 24",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"})})}function q(e){let{className:t="h-5 w-5"}=e;return(0,a.jsx)("svg",{className:t,viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z",clipRule:"evenodd"})})}function Q(e){let{className:t="h-5 w-5"}=e;return(0,a.jsx)("svg",{className:t,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M12 18l-6-4.5H3a1 1 0 01-1-1v-1.5a1 1 0 011-1h3l6-4.5v12z"})})}let Z=e=>{let{isDarkMode:t,onDarkModeToggle:r}=e,{t:s}=(0,o.B)();return(0,a.jsx)("div",{className:"h-full overflow-y-auto",children:(0,a.jsxs)("div",{className:"max-w-2xl mx-auto p-4 space-y-8 pb-20",children:[(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-6 text-gray-900 dark:text-gray-100",children:s("settings.appInfo")}),(0,a.jsxs)("div",{className:"space-y-4 bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("p",{className:"text-gray-700 dark:text-gray-300",children:s("settings.appDescription")}),(0,a.jsx)("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:(0,a.jsxs)("p",{children:[s("settings.version"),": ","1.0.0","  ",new Date().getFullYear().toString()," ",s("settings.copyright")," "]})})]})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-6 text-gray-900 dark:text-gray-100",children:s("settings.themePreference")}),(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-medium text-gray-900 dark:text-gray-100",children:s("settings.darkMode")}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s(t?"settings.themeDark":"settings.themeLight")})]}),(0,a.jsx)("button",{onClick:r,className:"\n                                    p-2 rounded-lg transition-colors\n                                    ".concat(t?"bg-blue-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300","\n                                "),"aria-label":"Toggle dark mode",children:(0,a.jsx)("span",{className:"text-xl",children:t?"\uD83C\uDF19":"☀️"})})]})})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-6 text-gray-900 dark:text-gray-100",children:s("settings.language")}),(0,a.jsx)("div",{className:"flex items-center justify-between",children:(0,a.jsx)(H,{})})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-6 text-gray-900 dark:text-gray-100",children:s("settings.about")}),(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsxs)("a",{href:G.GITHUB_REPO,target:"_blank",rel:"noopener noreferrer",className:" flex items-center justify-between p-4  bg-white dark:bg-gray-800  hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-700 transition-colors duration-200 ",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-medium text-gray-900 dark:text-gray-100",children:s("settings.viewSource")}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:s("settings.viewSourceDesc")})]}),(0,a.jsx)(K,{className:"w-6 h-6 text-gray-700 dark:text-gray-300"})]})})]})]})})},ee=e=>{let{message:t,onCancel:r}=e,{t:s}=(0,o.B)();return(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-center space-x-4",children:[(0,a.jsx)("div",{className:"w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}),(0,a.jsx)("p",{className:"text-gray-900 dark:text-gray-100",children:t||s("dialog.loading")})]}),r&&(0,a.jsx)("button",{onClick:r,className:"mt-4 w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors",children:s("dialog.cancel")})]})})};function et(e){let{currentView:t,onNavigate:r}=e,{t:s}=(0,o.B)(),n=[{view:"library",icon:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 10h16M4 14h16M4 18h16"})},{view:"discover",icon:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})},{view:"search",icon:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})},{view:"settings",icon:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})}];return(0,a.jsx)("nav",{className:"bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700",children:(0,a.jsx)("div",{className:"flex justify-around items-center h-14",children:n.map(e=>{let{view:o,icon:n}=e;return(0,a.jsxs)("button",{onClick:()=>r(o),className:"flex flex-col items-center px-4 py-2 transition-colors ".concat(t===o?"text-blue-600 dark:text-blue-400":"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200"),children:[(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n}),(0,a.jsx)("span",{className:"text-xs mt-1",children:s("common.".concat(o))})]},o)})})})}var er=r(6766);function ea(e){var t;let{novel:r}=e,[n,l]=(0,s.useState)(!1),{t:i}=(0,o.B)();return(0,a.jsxs)("div",{className:"flex flex-col p-3 rounded-lg bg-white dark:bg-gray-800 shadow-sm border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100",children:[(0,a.jsxs)("div",{className:"flex space-x-3",children:[r.cover&&(0,a.jsx)("div",{className:"relative w-20 h-28 flex-shrink-0",children:(0,a.jsx)(er.default,{src:r.cover,alt:r.title,fill:!0,className:"object-cover rounded"})}),(0,a.jsxs)("div",{className:"flex flex-col flex-1 min-w-0",children:[(0,a.jsx)("h3",{className:"font-medium break-words",children:r.title}),(0,a.jsxs)("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:[i("discover.novel.author"),": ",r.author]}),(0,a.jsx)("div",{className:"flex flex-wrap gap-1 mt-1",children:r.tags.slice(0,3).map(e=>(0,a.jsx)("span",{className:"text-xs px-2 py-0.5  bg-gray-100 dark:bg-gray-700  text-gray-700 dark:text-gray-300 rounded",children:e},e))}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-2",children:[(0,a.jsx)("div",{className:"flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-300",children:r.size&&(0,a.jsx)("span",{children:(t=r.size)?t<1024?"".concat(t,"B"):t<1048576?"".concat((t/1024).toFixed(1),"KB"):"".concat((t/1048576).toFixed(1),"MB"):""})}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[r.pageUrl&&(0,a.jsx)("a",{href:r.pageUrl,className:"p-1.5 rounded-full  hover:bg-gray-100 dark:hover:bg-gray-700  text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 cursor-pointer",title:i("discover.novel.visit"),children:(0,a.jsx)(q,{})}),r.downloadUrl&&(0,a.jsx)("a",{onClick:e=>{e.preventDefault(),window.location.href="/?add=".concat(encodeURIComponent(r.downloadUrl))},href:r.downloadUrl,className:"p-1.5 rounded-full  hover:bg-gray-100 dark:hover:bg-gray-700  text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 cursor-pointer",title:i("discover.novel.addToLibrary"),children:(0,a.jsx)(X,{})})]})]})]})]}),n&&(0,a.jsxs)("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[r.description&&(0,a.jsx)("p",{className:"text-sm text-gray-700 dark:text-gray-200 mb-2",children:r.description}),(0,a.jsx)("div",{className:"flex flex-wrap gap-1 mb-2",children:r.tags.map(e=>(0,a.jsx)("span",{className:"text-xs px-2 py-0.5  bg-gray-100 dark:bg-gray-700  text-gray-700 dark:text-gray-300 rounded",children:e},e))}),(0,a.jsxs)("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:[(0,a.jsxs)("p",{children:[i("discover.novel.categories"),": ",r.categories.join(", ")]}),(0,a.jsxs)("p",{children:[i("discover.novel.lastUpdated"),": ",r.lastUpdated]}),r.region&&(0,a.jsxs)("p",{children:[i("discover.novel.region"),": ",r.region]})]}),(0,a.jsxs)("div",{className:"flex gap-3 mt-4",children:[r.pageUrl&&(0,a.jsx)("a",{href:r.pageUrl,className:"text-blue-600 dark:text-blue-400 hover:text-blue-700  dark:hover:text-blue-300 font-medium transition-colors duration-200",children:i("discover.novel.visit")}),(0,a.jsx)("a",{href:"/?add=".concat(encodeURIComponent(r.downloadUrl)),"aria-label":i("discover.novel.addToLibrary"),className:"text-blue-600 dark:text-blue-400 hover:text-blue-700  dark:hover:text-blue-300 font-medium transition-colors duration-200",children:i("discover.novel.addToLibrary")})]})]}),(0,a.jsx)("button",{onClick:()=>l(!n),className:"mt-2 text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-gray-100 underline",children:i(n?"discover.novel.showLess":"discover.novel.showMore")})]})}function es(e){let{onImportComplete:t}=e,{t:r}=(0,o.B)(),n=(0,s.useRef)(null),l=(0,s.useRef)(null),i=async e=>{var r;let a=null===(r=e.target.files)||void 0===r?void 0:r[0];if(a)try{let e=await g.importFromFile(a);t(e)}catch(e){console.error("Import error:",e)}},d=async()=>{var e;let t=null===(e=l.current)||void 0===e?void 0:e.value;t&&(window.location.href="/?add=".concat(encodeURIComponent(t)))};return(0,a.jsxs)("section",{className:"flex items-center gap-4",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("button",{onClick:()=>{var e;return null===(e=n.current)||void 0===e?void 0:e.click()},className:"px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:r("discover.localImport")}),(0,a.jsx)("input",{ref:n,type:"file",accept:".txt",onChange:i,className:"hidden"})]}),(0,a.jsxs)("div",{className:"relative flex-1",children:[(0,a.jsx)("input",{ref:l,type:"url",placeholder:r("add.urlPlaceholder"),className:"w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400"}),(0,a.jsx)("button",{onClick:d,className:"absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm transition-colors",children:r("discover.urlImport")})]})]})}var eo=r(5695);function en(e){let{repo:t,onSync:r,onRemove:s,onViewChange:n}=e,{t:l}=(0,o.B)(),i=(0,eo.useRouter)();return(0,a.jsx)("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700",children:(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("h3",{className:"font-medium text-gray-900 dark:text-gray-100",children:t.meta.name}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"".concat(l("discover.repoCount")," ").concat(t.meta.novels)}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"".concat(l("discover.lastSync")," ").concat(new Date(t.lastSync).toLocaleString())}),(0,a.jsxs)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[l("discover.repoUrl")," ",(0,a.jsx)("span",{className:"break-all",children:t.url})]})]}),(0,a.jsxs)("div",{className:"flex space-x-2 ml-4",children:[(0,a.jsx)("button",{onClick:()=>{null==n||n("search"),i.push("/?search=".concat(encodeURIComponent(t.url)))},className:"p-2 text-blue-500 dark:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:l("discover.viewAll")}),(0,a.jsx)("button",{onClick:()=>r(t.url),className:"p-2 text-blue-500 dark:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:(0,a.jsx)(J,{className:"h-5 w-5"})}),(0,a.jsx)("button",{onClick:()=>s(t.url),className:"p-2 text-red-500 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:(0,a.jsx)(Y,{className:"h-5 w-5"})})]})]})})}function el(e){let{repositories:t,onAddClick:r,onSync:s,onRemove:n,onViewChange:l}=e,{t:i}=(0,o.B)();return(0,a.jsxs)("section",{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:i("discover.repositories")}),(0,a.jsxs)("button",{onClick:r,className:"flex items-center space-x-1 text-blue-500 dark:text-blue-400",children:[(0,a.jsx)($,{className:"h-5 w-5"}),(0,a.jsx)("span",{children:i("discover.addRepo")})]})]}),(0,a.jsx)("div",{className:"space-y-4",children:t.map(e=>(0,a.jsx)(en,{repo:e,onSync:s,onRemove:n,onViewChange:l},e.url))})]})}var ei=r(534);async function ed(e){try{let o=e.endsWith("search_index.yml")?e:e.replace(/\/?$/,"/search_index.yml"),n=await fetch(o);if(!n.ok)throw Error("Failed to fetch index: ".concat(n.statusText));let l=await n.text(),i=ei.Ay.load(l),d=new Set,c=new Set,g=new Set,h=[];for(let[o,n]of Object.entries(i)){var t,r,a,s;if(g.has(o)||(g.add(o),n.filename&&!n.filename.endsWith(".txt")))continue;null===(t=n.categories)||void 0===t||t.forEach(e=>d.add(e)),null===(r=n.tags)||void 0===r||r.forEach(e=>c.add(e));let l=(null===(a=n.filename)||void 0===a?void 0:a.replace(/\.[^/.]+$/,""))||(null===(s=o.split("/").pop())||void 0===s?void 0:s.replace(/\.[^/.]+$/,""))||"Untitled",i=e.replace(/\/search_index\.yml$/,"")+"/"+o,u=(i=i.replace(/\.md$/,"")).replace(/\/[^/]+$/,"")+"/"+n.filename;h.push({id:o,title:l,author:n.author||"Unknown",description:n.description||"",cover:null,tags:n.tags||[],categories:n.categories||[],chapters:n.chapters||0,date:n.date||new Date().toISOString(),lastUpdated:n["archived date"]||new Date().toISOString(),size:n.size,region:n.region,pageUrl:i,downloadUrl:u})}return{name:new URL(e).hostname.split(".")[0],novels:h,updatedNovels:h.length,lastSync:new Date().toISOString(),categories:Array.from(d),tags:Array.from(c)}}catch(e){throw console.error("Error fetching repo index:",e),Error("Failed to fetch repository data")}}async function ec(e){return await ed(e.url)}function eg(e){let{isOpen:t,isLoading:r,onClose:n,onAdd:l}=e,{t:i}=(0,o.B)(),[d,c]=(0,s.useState)("");return t?(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md",children:[(0,a.jsx)("h3",{className:"text-lg font-bold mb-4 text-gray-900 dark:text-gray-100",children:i("discover.addRepo")}),(0,a.jsx)("input",{type:"url",value:d,onChange:e=>c(e.target.value),placeholder:i("discover.addRepoUrl"),className:"w-full px-4 py-2 rounded-lg mb-4 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-600"}),(0,a.jsxs)("div",{className:"flex justify-end space-x-4",children:[(0,a.jsx)("button",{onClick:n,className:"px-4 py-2 text-gray-600 dark:text-gray-400",children:i("dialog.cancel")}),(0,a.jsx)("button",{onClick:()=>{d&&(l(d),c(""))},disabled:!d||r,className:"px-4 py-2 bg-blue-500 text-white rounded-lg disabled:bg-gray-300 dark:disabled:bg-gray-700",children:i("discover.addRepoButton")})]})]})}):null}function eh(e){let{onViewChange:t}=e,{t:r}=(0,o.B)(),n=(0,eo.useRouter)(),[l,i]=(0,s.useState)([]),[d,c]=(0,s.useState)(!1),[h,u]=(0,s.useState)(!1);(0,s.useEffect)(()=>{(async()=>{try{let e=await g.getAllRepositories();i(e)}catch(e){console.error("Failed to load repositories:",e)}})()},[]);let x=async e=>{if(e){if(l.find(t=>t.url===e)){alert(r("discover.error.repoExists"));return}u(!0);try{let t=await ed(e),r={url:e,meta:{name:t.name,description:"",url:e,lastUpdated:t.lastSync,novels:t.novels.length,updatedNovels:t.updatedNovels},lastSync:new Date().toISOString(),index:t};await g.saveRepository(r),i(e=>[...e,r]),c(!1)}catch(e){console.error("Failed to add repository:",e),alert(r("discover.error.invalidRepo"))}finally{u(!1)}}},m=async e=>{try{await g.deleteRepository(e),i(t=>t.filter(t=>t.url!==e))}catch(e){console.error("Failed to remove repository:",e)}},p=async e=>{u(!0);try{let t=l.find(t=>t.url===e);if(!t)return;let r=await ec(t),a={...t,index:r,lastSync:new Date().toISOString()};await g.saveRepository(a),i(t=>t.map(t=>t.url===e?a:t))}catch(e){console.error("Failed to sync repository:",e)}finally{u(!1)}};return(0,a.jsxs)("div",{className:"h-full flex flex-col overflow-hidden",children:[(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto px-4 py-6 space-y-8",children:[(0,a.jsx)(es,{onImportComplete:e=>{console.log("Novel imported:",e),alert(r("discover.importComplete")+e.title),n.push("/")}}),l.length>0&&(0,a.jsx)(a.Fragment,{children:(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-6 text-gray-900 dark:text-gray-100",children:r("discover.latest")}),(0,a.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4",children:(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return e.flatMap(e=>{var t;return(null===(t=e.index)||void 0===t?void 0:t.novels)||[]}).sort((e,t)=>{let r=e.lastUpdated?new Date(e.lastUpdated).getTime():0;return(t.lastUpdated?new Date(t.lastUpdated).getTime():0)-r}).slice(0,t)})(l).map(e=>(0,a.jsx)(ea,{novel:e},e.id))})]})}),(0,a.jsx)(el,{repositories:l,onAddClick:()=>c(!0),onSync:p,onRemove:m,onViewChange:t})]})}),(0,a.jsx)(eg,{isOpen:d,isLoading:h,onClose:()=>c(!1),onAdd:x})]})}function eu(e){let{onSearch:t,isSearching:r}=e,{t:n}=(0,o.B)(),[l,i]=(0,s.useState)("");return(0,a.jsxs)("form",{onSubmit:e=>{e.preventDefault(),t(l)},className:"flex gap-2",children:[(0,a.jsx)("input",{type:"text",value:l,onChange:e=>i(e.target.value),placeholder:n("discover.searchPlaceholder"),className:"flex-1 px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,a.jsx)("button",{type:"submit",disabled:r||!l.trim(),className:"px-4 py-2 rounded-lg bg-blue-500 text-white disabled:bg-gray-300 dark:disabled:bg-gray-700 hover:bg-blue-600 transition-colors",children:n(r?"dialog.loading":"reader.menu.search")})]})}function ex(e){let{results:t,defaultRank:r="relevance",onRankChange:s,currentPage:n,onPageChange:l,itemsPerPage:i=50}=e,{t:d}=(0,o.B)(),c=Math.ceil(t.length/i),g=(n-1)*i,h=t.slice(g,g+i);return(0,a.jsxs)("div",{className:"py-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center sticky top-0 bg-gray-50 dark:bg-gray-900 py-3 text-gray-900 dark:text-gray-100 z-10",children:[(0,a.jsxs)("h2",{className:"text-xl font-bold",children:[d("discover.searchResults")," (",t.length,")"]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("label",{htmlFor:"rank-select",className:"text-sm",children:[d("discover.sortBy"),":"]}),(0,a.jsxs)("select",{id:"rank-select",className:"bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-2 py-1 text-sm",value:r,onChange:e=>null==s?void 0:s(e.target.value),children:[(0,a.jsx)("option",{value:"relevance",children:d("discover.sortOptions.relevance")}),(0,a.jsx)("option",{value:"newest",children:d("discover.sortOptions.newest")}),(0,a.jsx)("option",{value:"popular",children:d("discover.sortOptions.popular")}),(0,a.jsx)("option",{value:"rating",children:d("discover.sortOptions.rating")})]})]})]}),(0,a.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-6 mt-6",children:h.map(e=>(0,a.jsx)(ea,{novel:e},e.id))}),c>1&&(0,a.jsxs)("div",{className:"mt-6 flex justify-center items-center gap-4",children:[(0,a.jsx)("button",{onClick:()=>{n>1&&l(n-1)},disabled:1===n,className:"px-4 py-2 rounded-lg bg-blue-500 text-white disabled:bg-gray-300 dark:disabled:bg-gray-700 hover:bg-blue-600 transition-colors",children:d("common.previous")}),(0,a.jsx)("span",{className:"text-gray-700 dark:text-gray-300",children:"".concat(n," / ").concat(c)}),(0,a.jsx)("button",{onClick:()=>{n<c&&l(n+1)},disabled:n===c,className:"px-4 py-2 rounded-lg bg-blue-500 text-white disabled:bg-gray-300 dark:disabled:bg-gray-700 hover:bg-blue-600 transition-colors",children:d("common.next")})]})]})}function em(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=[];for(let n of e){var s,o;if(null===(s=n.index)||void 0===s?void 0:s.novels)for(let e of n.index.novels)(r||e.title.toLowerCase().includes(t.toLowerCase())||(null===(o=e.description)||void 0===o?void 0:o.toLowerCase().includes(t.toLowerCase())))&&a.push({...e,repoUrl:n.url,score:function(e,t){if(!t)return 1;let r=t.toLowerCase().split(/\s+/),a=0;return r.forEach(t=>{e.title.toLowerCase().includes(t)&&(a+=3)}),r.forEach(t=>{var r;(null===(r=e.description)||void 0===r?void 0:r.toLowerCase().includes(t))&&(a+=1)}),r.forEach(t=>{var r;(null===(r=e.author)||void 0===r?void 0:r.toLowerCase().includes(t))&&(a+=2)}),a}(e,t)})}return a}function ep(e,t){return[...e].sort((e,r)=>{switch(t){case"relevance":return r.score-e.score;case"newest":return new Date(r.lastUpdated).getTime()-new Date(e.lastUpdated).getTime();case"popular":return(r.size||0)-(e.size||0);case"rating":let a=(e.size||0)/1e3+(e.chapters||0);return(r.size||0)/1e3+(r.chapters||0)-a;default:return 0}})}function ey(e){let{repositories:t,onSearching:r,className:n=""}=e,{t:l}=(0,o.B)(),[i,d]=(0,s.useState)([]),[c,g]=(0,s.useState)(!1),[h,u]=(0,s.useState)(""),[x,m]=(0,s.useState)("relevance"),[p,y]=(0,s.useState)(1),v=(0,s.useCallback)(async e=>{g(!0),r(!0);try{let t=em([e],"",!0),r=ep(t,x);d(r),y(1)}catch(e){console.error("Failed to search repository:",e),d([])}finally{g(!1),r(!1)}},[x,r]);(0,s.useEffect)(()=>{let e=new URLSearchParams(window.location.search).get("search");if(e){let r=t.find(t=>t.url===e);r&&v(r)}},[t,v]);let b=(0,s.useCallback)(async e=>{if(u(e),!e.trim()){d([]),r(!1);return}g(!0),r(!0);try{let r=em(t,e),a=ep(r,x);d(a),y(1)}catch(e){console.error("Search error:",e),d([])}finally{g(!1),r(!1)}},[t,x,r]),f=(0,s.useCallback)(e=>{m(e),d(t=>ep(t,e))},[]),k=(0,s.useCallback)(e=>{y(e),window.scrollTo({top:0,behavior:"smooth"})},[]);return(0,a.jsxs)("div",{className:"".concat(n," flex flex-col h-full"),children:[(0,a.jsx)("div",{className:"flex-none bg-gray-50 dark:bg-gray-900 p-4 shadow-sm",children:(0,a.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,a.jsx)(eu,{onSearch:b,isSearching:c})})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto min-h-0",children:(0,a.jsx)("div",{className:"max-w-4xl mx-auto px-4",children:i.length>0?(0,a.jsx)(ex,{results:i,defaultRank:x,onRankChange:f,currentPage:p,onPageChange:k,itemsPerPage:50}):h?(0,a.jsx)("div",{className:"py-8 text-center text-gray-500 dark:text-gray-400",children:l("discover.noResults")}):null})})]})}async function ev(e,t){let{onLoading:r,onLoadingMessage:a,onNovelSelect:s,t:o}=t;try{let t=new URL(e).origin,n=await g.findNovelByUrl(e);if(n&&!window.confirm(o("add.confirmRedownload"))){s(n);return}let l=await g.getAllRepositories();if(!l.some(e=>e.url===t)&&window.confirm(o("add.confirmImportRepo")))try{await eb([t],{repositories:l,onLoading:r,onLoadingMessage:a,onRepositoriesChange:e=>{console.log("Repositories changed:",e)},onViewChange:()=>{},t:o})}catch(e){console.error("Failed to import repository:",e)}r(!0),a(o("add.loadingUrl"));let i=await g.importFromUrl(e);s(i)}catch(e){console.error("Failed to import novel from URL:",e),window.alert(o("add.error.url"))}finally{r(!1),a("")}}async function eb(e,t){let{repositories:r,onLoading:a,onLoadingMessage:s,onRepositoriesChange:o,onViewChange:n,t:l}=t;a(!0),s(l("discover.addRepoButton"));try{let t=!1;for(let a of e){let e=r.find(e=>e.url===a);if(e)try{let s=await ec(e),n={...e,index:s,lastSync:new Date().toISOString()};await g.saveRepository(n),o(r.map(e=>e.url===a?n:e)),t=!0}catch(e){console.error("Failed to sync repository ".concat(a,":"),e);continue}else try{let e=await ed(a),s={url:a,meta:{name:e.name,description:"",url:a,lastUpdated:e.lastSync,novels:e.novels.length,updatedNovels:e.updatedNovels},lastSync:new Date().toISOString(),index:e};await g.saveRepository(s),o([...r,s]),t=!0}catch(e){console.error("Failed to add repository ".concat(a,":"),e);continue}}t&&(window.alert(l("add.repoImported")),n("discover"))}catch(e){console.error("Failed to handle repositories:",e),window.alert(l("discover.error.invalidRepo"))}finally{a(!1),s("")}}function ef(){let{t:e}=(0,o.B)(),[t,r]=(0,s.useState)("library"),[l,i]=(0,s.useState)(null),[d,c]=(0,s.useState)(""),[h,u]=(0,s.useState)(0),[m,p]=(0,s.useState)(!1),[y,v]=(0,s.useState)(!1),[b,f]=(0,s.useState)(""),[k,w]=(0,s.useState)([]),[j,N]=(0,s.useState)(!1),[S,C]=(0,s.useState)(!1),L=(0,s.useCallback)(async e=>{let t=await g.getNovelContent(e.id);i(e),c(t),u(e.lastPosition),r("reader")},[]);(0,s.useEffect)(()=>{let t=()=>{let t=new URLSearchParams(window.location.search),a=t.get("add"),s=t.get("repos");if(t.get("search")&&r("search"),s){let t=s.split(",").filter(e=>e.trim());t.length>0&&(eb(t,{repositories:k,onLoading:v,onLoadingMessage:f,onRepositoriesChange:w,onViewChange:r,t:e}),window.history.replaceState({},"",window.location.pathname))}else a&&(ev(a,{onLoading:v,onLoadingMessage:f,onNovelSelect:L,t:e}),window.history.replaceState({},"",window.location.pathname))};return window.addEventListener("popstate",t),t(),()=>{window.removeEventListener("popstate",t)}},[L,k,e]),(0,s.useEffect)(()=>{let e=localStorage.getItem("darkMode"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,r=e?"true"===e:t;p(r),r?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")},[]);let R=(0,s.useCallback)(()=>{p(e=>{let t=!e;return t?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),localStorage.setItem("darkMode",t.toString()),t})},[]),E=(0,s.useCallback)(e=>{u(e),l&&g.updateNovelProgress(l.id,e)},[l]),M=(0,s.useCallback)(()=>{i(null),c(""),u(0),r("library")},[]),T=(0,s.useCallback)(e=>{"reader"===t&&"reader"!==e&&M(),r(e)},[t,M]);return(0,s.useEffect)(()=>{(async()=>{try{let e=await g.getAllRepositories();w(e)}catch(e){console.error("Failed to load repositories:",e)}})()},[]),(0,a.jsx)("div",{className:"h-[100dvh] w-screen overflow-hidden bg-gray-50 dark:bg-gray-900",children:(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsx)(n,{title:(()=>{switch(t){case"reader":return(null==l?void 0:l.title)||e("reader.title");case"settings":return e("common.settings");case"discover":return e("common.discover");case"search":return e("common.search");default:return e("library.title")}})(),buttons:"reader"===t?[{icon:(0,a.jsx)(Q,{}),onClick:()=>C(e=>!e),ariaLabel:S?"Disable text-to-speech":"Enable text-to-speech"},{icon:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 12h16M4 18h16"})}),onClick:()=>N(!0),ariaLabel:"Open reader menu"}]:"library"===t?[{icon:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})}),onClick:()=>window.location.href=G.HOME_PAGE,ariaLabel:e("common.home")}]:[],onBackClick:(()=>{if("library"!==t)return M})()}),(0,a.jsxs)("div",{className:"flex-1 min-h-0",children:["library"===t&&(0,a.jsx)(x,{onNovelSelect:L}),"reader"===t&&l&&(0,a.jsx)("div",{className:"h-full flex relative",children:(0,a.jsx)("div",{className:"flex-1 min-w-0 h-full",children:(0,a.jsx)(W,{content:d,currentOffset:h,onPositionChange:E,defaultConfig:{fontSize:20,isPaged:!1},showMenu:j,onMenuClose:()=>N(!1),isTTSMode:S})})}),"settings"===t&&(0,a.jsx)(Z,{isDarkMode:m,onDarkModeToggle:R}),"discover"===t&&(0,a.jsx)(eh,{onViewChange:r}),"search"===t&&(0,a.jsx)("div",{className:"h-full",children:(0,a.jsx)(ey,{repositories:k,onSearching:()=>{},className:"h-full"})}),y&&(0,a.jsx)(ee,{message:b,onCancel:()=>v(!1)})]}),"reader"!==t&&(0,a.jsx)(et,{currentView:t,onNavigate:T})]})})}},6489:(e,t,r)=>{"use strict";r.d(t,{LanguageProvider:()=>h,B:()=>u});var a=r(5155),s=r(2115);let o=()=>{let e=navigator.language.toLowerCase();return["en","zh"].find(t=>e.startsWith(t))||"en"},n={en:{"common.back":"Back","common.settings":"Settings","common.close":"Close","common.home":"Home","navigation.library":"Library","navigation.reader":"Reader","navigation.settings":"Settings","navigation.add":"Add","reader.title":"Reading","library.title":"Novel Reader","library.import":"Import Novel","library.noNovels":"No novels yet","settings.darkMode":"Dark Mode","settings.language":"Language","reader.menu.settings":"Settings","reader.menu.bookmarks":"Bookmarks","reader.menu.chapters":"Chapters","reader.menu.search":"Search","reader.menu.fontSize":"Font Size","reader.menu.pageMode":"Page Mode","reader.menu.scrollMode":"Scroll Mode","reader.menu.title":"Reader Menu","library.search":"Search novels...","library.sort.recentlyRead":"Recently Read","library.sort.title":"Title","library.select":"Select","library.cancel":"Cancel","library.delete":"Delete","library.export":"Export","add.uploadTitle":"Upload File","add.urlTitle":"Import from URL","add.urlPlaceholder":"Enter URL","add.import":"Import","add.loading":"Opening {filename}...","add.loadingUrl":"Downloading from URL...","add.error.import":"Failed to import file. Please try again.","add.error.url":"Failed to import from URL. Please check the URL and try again.","add.error.cancelled":"Import cancelled.","dialog.loading":"Loading...","dialog.cancel":"Cancel","common.library":"Library","common.discover":"Discover","discover.comingSoon":"Discover feature coming soon!","discover.repositories":"Repositories","discover.addRepo":"Add Repository","discover.addRepoUrl":"Repository URL","discover.addRepoButton":"Add","discover.popular":"Popular","discover.latest":"Latest Updates","discover.categories":"Categories","discover.search":"Search novels...","discover.localImport":"Import Local File","discover.urlImport":"Import from URL","discover.repoStats":"{novels} novels, {updated} updated","discover.lastSync":"Last sync: ","discover.sync":"Sync Now","discover.removeRepo":"Remove","discover.error.invalidRepo":"Invalid repository URL","discover.error.fetchFailed":"Failed to fetch repository data","discover.error.repoExists":"Repository already exists","discover.importComplete":'Successfully imported "{title}"',"discover.searchResults":"Search Results","discover.searchPlaceholder":"Search by title, author...","navigation.discover":"Discover","navigation.search":"Search","common.search":"Search","discover.noResults":"No results found","discover.repoUrl":"Repository URL:","discover.repoCount":"Novels:","discover.novel.author":"Author","discover.novel.categories":"Categories","discover.novel.lastUpdated":"Last Updated","discover.novel.region":"Region","discover.novel.visit":"Visit Page","discover.novel.showMore":"Show more","discover.novel.showLess":"Show less","discover.novel.addToLibrary":"Add to Library","settings.appInfo":"About","settings.appDescription":"A decentralized novel reader that prioritizes privacy by processing all data locally, with no login required. Connect to any compatible repository or import your own content.","settings.privacyTitle":"Privacy First","settings.privacyDescription":"All data is processed locally. No login required, no tracking.","settings.decentralizedTitle":"Decentralized","settings.decentralizedDescription":"Connect to any compatible repository or import your own content","settings.version":"Version","settings.sourceCode":"Source Code","settings.license":"License","settings.themePreference":"Theme Preference","settings.themeAuto":"System","settings.themeLight":"Light","settings.themeDark":"Dark","settings.theme":"Theme","settings.fontSize":"Font Size","settings.readingMode":"Reading Mode","settings.charactersPerPage":"Characters Per Page","settings.pagedMode":"Paged Mode","settings.scrollMode":"Scroll Mode","settings.about":"About","settings.viewSource":"View Source Code","settings.viewSourceDesc":"Check out our GitHub repository","settings.copyright":"\xa9 {year} Web Novel Reader","settings.licenseMIT":"MIT License","add.confirmRedownload":"This novel already exists. Do you want to download it again?","add.confirmImportRepo":"This novel is from a new repository. Would you like to import the repository data as well?","add.repoImported":"Repository successfully imported!","discover.sortBy":"Sort by","discover.sortOptions.relevance":"Relevance","discover.sortOptions.newest":"Newest","discover.sortOptions.popular":"Popular","discover.sortOptions.rating":"Rating","discover.viewAll":"View All","common.previous":"Previous","common.next":"Next","common.pageCount":"Page {current} of {total}","tts.speed":"Reading Speed","tts.language":"Language","tts.voice":"Voice","tts.start":"Start Reading","tts.stop":"Stop Reading","tts.section":"Section {current} of {total}","tts.previous":"Previous Section","tts.next":"Next Section"},zh:{"common.back":"返回","common.settings":"设置","common.close":"关闭","common.home":"主页","navigation.library":"书架","navigation.reader":"阅读器","navigation.settings":"设置","navigation.add":"添加","reader.title":"打开中...","library.title":"小说阅读器","library.import":"导入小说","library.noNovels":"暂无小说","settings.darkMode":"深色模式","settings.language":"语言","reader.menu.settings":"设置","reader.menu.bookmarks":"书签","reader.menu.chapters":"章节","reader.menu.search":"搜索","reader.menu.fontSize":"字体大小","reader.menu.pageMode":"分页模式","reader.menu.scrollMode":"滚动模式","reader.menu.title":"阅读菜单","library.search":"搜索小说...","library.sort.recentlyRead":"最近阅读","library.sort.title":"标题","library.select":"选择","library.cancel":"取消","library.delete":"删除","library.export":"导出","add.uploadTitle":"上传文件","add.urlTitle":"从网址导入","add.urlPlaceholder":"输入网址","add.import":"导入","add.loading":"正在打开 {filename}...","add.loadingUrl":"正在从网址下载...","add.error.import":"导入文件失败。请重试。","add.error.url":"从网址导入失败。请检查网址后重试。","add.error.cancelled":"导入已取消。","dialog.loading":"加载中...","dialog.cancel":"取消","common.library":"书架","common.discover":"发现","discover.comingSoon":"发现功能即将推出！","discover.repositories":"书源","discover.addRepo":"添加书源","discover.addRepoUrl":"书源地址","discover.addRepoButton":"添加","discover.popular":"热门推荐","discover.latest":"最近更新","discover.categories":"分类","discover.search":"搜索小说...","discover.localImport":"导入本地文件","discover.urlImport":"从网址导入","discover.repoStats":"{novels} 部小说，{updated} 部更新","discover.lastSync":"上次同步：","discover.sync":"立即同步","discover.removeRepo":"移除","discover.error.invalidRepo":"无效的书源地址","discover.error.fetchFailed":"获取书源数据失败","discover.error.repoExists":"书源已存在","discover.importComplete":"成功导入《{title}》","discover.searchResults":"搜索结果","discover.searchPlaceholder":"按标题、作者搜索...","navigation.discover":"发现","navigation.search":"搜索","common.search":"搜索","discover.noResults":"未找到结果","discover.repoUrl":"书源地址：","discover.repoCount":"小说数量：","discover.novel.author":"作者","discover.novel.categories":"分类","discover.novel.lastUpdated":"最后更新","discover.novel.region":"地区","discover.novel.visit":"访问网页","discover.novel.showMore":"显示更多","discover.novel.showLess":"收起","discover.novel.addToLibrary":"添加到书架","settings.appInfo":"关于","settings.appDescription":"去中心化、跨平台的在线阅读器，通过本地处理所有数据来保护隐私。可以通过 PWA 安装到任意平台。连接任何兼容的书源搜索或导入本地内容。","settings.privacyTitle":"隐私优先","settings.privacyDescription":"所有数据本地处理，无需登录，无跟踪","settings.decentralizedTitle":"去中心化","settings.decentralizedDescription":"连接任何兼容的书源或导入自己的内容","settings.version":"版本","settings.sourceCode":"源代码","settings.license":"许可证","settings.themePreference":"主题偏好","settings.themeAuto":"跟随系统","settings.themeLight":"浅色","settings.themeDark":"深色","settings.theme":"主题","settings.fontSize":"字体大小","settings.readingMode":"阅读模式","settings.charactersPerPage":"每页字数","settings.pagedMode":"分页模式","settings.scrollMode":"滚动模式","settings.about":"关于","settings.viewSource":"查看源代码","settings.viewSourceDesc":"访问我们的 GitHub 仓库","settings.copyright":"\xa9 Web Novel Reader","settings.licenseMIT":"MIT 许可证","add.confirmRedownload":"该小说已存在。是否重新下载？","add.confirmImportRepo":"该小说来自新的书源。是否同时导入书源数据？","add.repoImported":"书源导入成功！","discover.sortBy":"排序方式","discover.sortOptions.relevance":"相关度","discover.sortOptions.newest":"最新","discover.sortOptions.popular":"热门","discover.sortOptions.rating":"评分","discover.viewAll":"查看全部","common.previous":"上一页","common.next":"下一页","common.pageCount":"第 {current} 页，共 {total} 页","tts.speed":"朗读速度","tts.language":"语言","tts.voice":"声音","tts.start":"开始朗读","tts.stop":"停止朗读","tts.section":"第 {current} 节，共 {total} 节","tts.previous":"上一节","tts.next":"下一节"}},l=["en","zh"],i=()=>{let e=localStorage.getItem("preferred-language");return e&&l.includes(e)?e:null},d=e=>{localStorage.setItem("preferred-language",e)},c=(e,t)=>r=>{var a;return(null===(a=e[t])||void 0===a?void 0:a[r])||r},g=(0,s.createContext)({language:"en",setLanguage:()=>{},t:e=>e}),h=e=>{let{children:t,initialLang:r}=e,[l,h]=(0,s.useState)(r);(0,s.useEffect)(()=>{let e=i();if(e){h(e);return}let t=o();t!==l&&(h(t),d(t))},[l]);let u=c(n,l);return(0,a.jsx)(g.Provider,{value:{language:l,setLanguage:e=>{h(e),d(e)},t:u},children:t})},u=()=>{let e=(0,s.useContext)(g);if(!e)throw Error("useTranslation must be used within a LanguageProvider");return e}}},e=>{var t=t=>e(e.s=t);e.O(0,[480,474,441,684,358],()=>t(258)),_N_E=e.O()}]);